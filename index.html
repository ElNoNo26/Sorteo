<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"> 
    <meta name="theme-color" content="#1e1b4b">
    <title>Editor Rifa V16 (Fotos Pro & Delete)</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        /* ESTILOS DEL EDITOR (Base oscura) */
        :root { 
            --bg: #0f172a; --sidebar: #1e1b4b; --text: #ffffff; --text-light: #94a3b8;  
            --card-bg: #1e293b; --input-bg: #334155; --border-color: #475569;
            --primary: #8b5cf6; --accent: #fbbf24; --danger: #ef4444; --success: #10b981; --fab-bg: #020617;      
            --sold: #ef4444; --reserved: #f59e0b; --free: #10b981;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); display: flex; flex-direction: column; height: 100vh; margin: 0; overflow: hidden; font-size: 14px; }
        
        /* LOGIN */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; background-image: radial-gradient(circle at center, #312e81 0%, #000 80%); padding-bottom: 20vh; }
        .login-box { width: 85%; max-width: 280px; text-align: center; }
        .login-avatar { width: 80px; height: 80px; background: var(--primary); border-radius: 50%; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; font-size: 2.5rem; box-shadow: 0 0 25px rgba(139, 92, 246, 0.6); border: 2px solid var(--accent); }
        .login-input { background: #222 !important; border: 1px solid #444; color: white !important; padding: 12px; border-radius: 10px; width: 100%; font-size: 1.2rem; text-align: center; letter-spacing: 5px; outline: none; margin-bottom: 15px; }
        .btn-login { background: linear-gradient(to right, var(--primary), #4c1d95); color: white; border: none; padding: 12px; width: 100%; border-radius: 10px; font-weight: 800; font-size: 1rem; cursor: pointer; text-transform: uppercase; box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4); }

        /* NAV */
        .mobile-header { background: var(--sidebar); padding: 10px 0; border-bottom: 1px solid var(--primary); display: flex; align-items: center; z-index: 100; flex-shrink: 0; padding-right: 15px; }
        .nav-scroller { display: flex; overflow-x: auto; gap: 8px; padding: 0 15px; flex: 1; scrollbar-width: none; }
        .nav-pill { white-space: nowrap; padding: 8px 16px; border-radius: 20px; font-size: 0.85rem; color: var(--text-light); background: rgba(255,255,255,0.05); transition: 0.2s; border: 1px solid transparent; cursor: pointer; }
        .nav-pill.active { background: var(--primary); color: white; font-weight: 700; border-color: var(--accent); box-shadow: 0 0 10px rgba(139, 92, 246, 0.4); }

        /* MAIN */
        main { flex: 1; padding: 10px; overflow-y: auto; padding-bottom: 120px; }
        .panel { display: none; animation: fadeIn 0.3s ease; width: 100%; }
        .panel.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* CARDS & INPUTS */
        .card { background: var(--card-bg); padding: 12px; border-radius: 12px; border: 1px solid var(--border-color); margin-bottom: 10px; }
        h1 { margin: 0 0 10px 0; font-size: 1.4rem; font-weight: 800; color: var(--primary); letter-spacing: -0.5px; }
        h1 span { color: var(--accent); }
        h3 { margin: 0 0 6px 0; color: var(--accent); font-size: 0.9rem; text-transform: uppercase; }
        
        label { display: block; margin-bottom: 2px; font-weight: 600; font-size: 0.7rem; color: var(--text-light); text-transform: uppercase; }
        input, textarea, select { width: 100%; padding: 8px 10px; margin-bottom: 0; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.9rem; background: var(--input-bg); color: white; outline: none; font-family: inherit; }
        input:focus { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.2); }

        .input-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        .input-group { margin-bottom: 10px; }

        .btn-primary { background: var(--primary); color: white; width: 100%; padding: 10px; border-radius: 8px; font-weight: bold; border: none; cursor: pointer; margin-bottom: 8px; font-size: 0.9rem; }
        .btn-success { background: var(--success); color: white; width: 100%; padding: 10px; border-radius: 8px; font-weight: bold; border: none; cursor: pointer; font-size: 0.9rem; }
        .btn-outline { background: transparent; border: 1px solid var(--border-color); color: var(--text-light); width: 100%; padding: 8px; border-radius: 8px; cursor: pointer; font-size: 0.9rem; }
        .btn-download { background: linear-gradient(45deg, #ec4899, #8b5cf6); color: white; width: 100%; padding: 12px; border-radius: 8px; font-weight: 800; border: none; cursor: pointer; font-size: 0.95rem; margin-bottom: 10px; box-shadow: 0 4px 10px rgba(236, 72, 153, 0.3); }

        /* GRID NUMEROS */
        .ticket-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(35px, 1fr)); gap: 5px; margin-top: 10px; }
        .ticket-cell { aspect-ratio: 1; border-radius: 5px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 0.75rem; cursor: pointer; border: 1px solid rgba(255,255,255,0.1); position: relative; }
        .ticket-cell.free { background: rgba(16, 185, 129, 0.2); color: var(--free); border-color: var(--free); }
        .ticket-cell.sold { background: rgba(239, 68, 68, 0.2); color: var(--sold); border-color: var(--sold); text-decoration: line-through; opacity: 0.7; }
        .ticket-cell.reserved { background: rgba(245, 158, 11, 0.2); color: var(--reserved); border-color: var(--reserved); }

        /* ESTILOS NUEVOS PARA FOTOS (HISTORIAL) */
        .upload-zone { border: 2px dashed #444; padding: 25px; text-align: center; border-radius: 12px; background: rgba(0,0,0,0.2); cursor: pointer; transition: 0.2s; }
        .upload-zone:active { background: rgba(255,255,255,0.05); border-color: var(--primary); }
        
        .history-header { display: flex; justify-content: space-between; align-items: center; margin: 20px 0 10px 0; }
        .history-card { background: #1e293b; border: 1px solid #334155; border-radius: 12px; padding: 10px; display: flex; align-items: center; gap: 12px; margin-bottom: 10px; }
        .history-thumb { width: 60px; height: 60px; border-radius: 8px; object-fit: cover; background: #000; border: 1px solid #444; }
        .history-info { flex: 1; overflow: hidden; }
        .history-url { font-size: 0.75rem; color: #94a3b8; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 4px; display: block; }
        .history-date { font-size: 0.65rem; color: #555; font-weight: bold; }
        .history-actions { display: flex; gap: 8px; }
        .btn-icon-sm { width: 36px; height: 36px; border-radius: 8px; border: 1px solid #475569; background: #0f172a; color: white; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 1.1rem; }
        .btn-delete-sm { border-color: #7f1d1d; background: #450a0a; color: #f87171; }

        /* LISTA PREMIOS */
        .prize-item { background: #0f172a; border: 1px solid var(--accent); padding: 8px; border-radius: 8px; margin-bottom: 8px; display: flex; gap: 10px; align-items: center; }
        .prize-img-sm { width: 45px; height: 45px; object-fit: cover; border-radius: 5px; background: #000; }

        /* UI GENERICA */
        #toast { visibility: hidden; min-width: 250px; background-color: #111; border: 1px solid var(--accent); color: #fff; text-align: center; border-radius: 50px; padding: 12px; position: fixed; z-index: 5000; left: 50%; bottom: 100px; transform: translateX(-50%); font-size: 0.9rem; opacity: 0; transition: 0.3s; font-weight: bold; }
        #toast.show { visibility: visible; opacity: 1; bottom: 110px; }

        .fab-container { position: fixed; bottom: 0; left: 0; right: 0; display: grid; grid-template-columns: repeat(5, 1fr); background: var(--fab-bg); border-top: 1px solid var(--primary); z-index: 1000; padding-bottom: env(safe-area-inset-bottom); height: 75px; }
        .fab-btn { background: transparent; border: none; color: #888; padding: 5px 0; font-size: 0.65rem; display: flex; flex-direction: column; align-items: center; gap: 4px; cursor: pointer; justify-content: center; }
        .fab-icon { font-size: 1.3rem; margin-bottom: 2px; }

        /* MODAL */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 2000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-overlay.open { display: flex; }
        .modal-content { background: var(--card-bg); width: 95%; max-width: 500px; max-height: 90vh; border-radius: 15px; border: 1px solid var(--primary); display: flex; flex-direction: column; overflow: hidden; padding: 20px; overflow-y: auto; }
        .preview-box { background: rgba(59, 130, 246, 0.1); border: 2px dashed #3b82f6; color: #3b82f6; padding: 15px; border-radius: 12px; text-align: center; margin-bottom: 15px; cursor: pointer; }
    </style>
</head>
<body>

    <div id="toast">üíæ Guardado con √©xito</div>

    <!-- LOGIN -->
    <div id="login-screen">
        <div class="login-box">
            <div class="login-avatar">üé´</div>
            <h2 style="color:white; margin-bottom:25px; font-weight:800;">RIFA MANAGER</h2>
            <input type="password" id="login-pass" class="login-input" placeholder="****" inputmode="numeric">
            <button class="btn-login" onclick="checkLogin()">INGRESAR PANEL</button>
        </div>
    </div>

    <!-- HEADER -->
    <div class="mobile-header">
        <div class="nav-scroller">
            <div class="nav-pill active" onclick="switchPanel(0)">üìä Panel</div>
            <div class="nav-pill" onclick="switchPanel(1)">‚öôÔ∏è Datos</div>
            <div class="nav-pill" onclick="switchPanel(2)">üèÜ Premios</div>
            <div class="nav-pill" onclick="switchPanel(3)">üì∏ Fotos</div>
        </div>
    </div>

    <main id="main-editor">
        <!-- PANEL 0: DASHBOARD -->
        <div id="panel-0" class="panel active">
            <h1>Resumen del Sorteo</h1>
            
            <div class="preview-box" onclick="openPreview()">
                <div style="font-size: 1.1rem; font-weight: 800;">üëÅÔ∏è Vista Previa</div>
                <div style="font-size: 0.8rem; opacity: 0.8;">Ver cambios antes de publicar</div>
            </div>

            <!-- Boton Descargar HTML -->
            <button class="btn-download" onclick="downloadIndex()">üì• DESCARGAR INDEX.HTML</button>

            <div class="card" style="display:flex; gap:10px; text-align:center;">
                <div style="flex:1; background:#111; padding:8px; border-radius:8px;">
                    <span id="stat-sold" style="font-size:1.5rem; font-weight:800; color:var(--sold); display:block;">0</span>
                    <span style="font-size:0.6rem; color:#aaa;">VENDIDOS</span>
                </div>
                <div style="flex:1; background:#111; padding:8px; border-radius:8px;">
                    <span id="stat-reserved" style="font-size:1.5rem; font-weight:800; color:var(--reserved); display:block;">0</span>
                    <span style="font-size:0.6rem; color:#aaa;">RESERVADOS</span>
                </div>
                <div style="flex:1; background:#111; padding:8px; border-radius:8px;">
                    <span id="stat-free" style="font-size:1.5rem; font-weight:800; color:var(--free); display:block;">0</span>
                    <span style="font-size:0.6rem; color:#aaa;">LIBRES</span>
                </div>
            </div>

            <div class="card">
                <h3 style="display:flex; justify-content:space-between; margin-top:0;">Recaudaci√≥n Est. <span id="stat-money" style="color:white;">$0</span></h3>
                <p style="font-size:0.75rem; color:#aaa; margin-bottom:10px;">Basado en n√∫meros vendidos.</p>
                <button class="btn-outline" style="border-color:var(--danger); color:var(--danger);" onclick="resetDefault()">‚ö†Ô∏è REINICIAR DE F√ÅBRICA</button>
                
                <!-- AVISO DE RESTAURACION -->
                <div id="restore-notice" class="restore-box">
                    <p>üíæ Se encontraron datos guardados</p>
                    <button class="btn-primary" style="margin:0;" onclick="loadDraft()">RESTAURAR BORRADOR</button>
                </div>
            </div>
        </div>

        <!-- PANEL 1: CONFIGURACI√ìN -->
        <div id="panel-1" class="panel">
            <h1>Configuraci√≥n</h1>
            <div class="card">
                <!-- TITULO -->
                <div class="input-group">
                    <label>T√≠tulo (Texto)</label>
                    <input type="text" id="cfg-title" oninput="saveToDraft(false)" placeholder="Ej: Gran Rifa Solidaria">
                </div>

                <!-- LOGO COMPACTO -->
                <div class="input-group" style="background:rgba(0,0,0,0.2); padding:8px; border-radius:8px; border:1px solid #334155;">
                    <label style="color:var(--accent)">URL Logo (Opcional)</label>
                    <input type="text" id="cfg-logo" oninput="saveToDraft(false)" placeholder="https://..." style="margin-bottom:5px;">
                    <div style="display:flex; align-items:center; gap:10px;">
                        <label style="margin:0; min-width:70px;">Tama√±o: <span id="logo-scale-val">50</span>%</label>
                        <input type="range" id="cfg-logo-scale" min="10" max="100" step="5" value="50" oninput="updateScaleVal(this.value); saveToDraft(false);" style="margin:0;">
                    </div>
                </div>

                <!-- FILA 1: PRECIO Y FECHA -->
                <div class="input-row">
                    <div>
                        <label>Precio ($)</label>
                        <input type="number" id="cfg-price" oninput="saveToDraft(false)" placeholder="1000">
                    </div>
                    <div>
                        <label>Fecha (Interna)</label>
                        <input type="text" id="cfg-date" oninput="saveToDraft(false)" placeholder="Ej: 25/12">
                    </div>
                </div>

                <!-- FILA 2: CBU Y WHATSAPP -->
                <div class="input-row">
                    <div>
                        <label>Alias / CBU</label>
                        <input type="text" id="cfg-cbu" oninput="saveToDraft(false)" placeholder="alias.pago">
                    </div>
                    <div>
                        <label>WhatsApp</label>
                        <div style="display:flex; align-items:stretch;">
                            <span style="background:#222; padding:0 5px; border-radius:6px 0 0 6px; color:#888; border:1px solid var(--border-color); border-right:none; display:flex; align-items:center; font-size:0.75rem;">+549</span>
                            <input type="tel" id="cfg-whatsapp" oninput="saveToDraft(false)" placeholder="11223344" style="border-radius:0 6px 6px 0; margin-bottom:0;">
                        </div>
                    </div>
                </div>

                <div class="input-group">
                    <label>Mensaje Pie de P√°gina</label>
                    <input type="text" id="cfg-footer-msg" oninput="saveToDraft(false)" placeholder="Ej: ¬°Gracias por colaborar!">
                </div>

                <div class="input-group">
                    <label>Banner Principal (URL)</label>
                    <input type="text" id="cfg-banner" oninput="saveToDraft(false)">
                </div>
            </div>

            <div class="card" style="border-color: #3b82f6; background:#0f172a;">
                <h3 style="color:#60a5fa; margin-top:0;">‚òÅÔ∏è GitHub API</h3>
                <div class="input-row">
                    <div><label>Usuario</label><input type="text" id="gh-user"></div>
                    <div><label>Repositorio</label><input type="text" id="gh-repo"></div>
                </div>
                <label>Token</label><input type="password" id="gh-token">
                <button class="btn-primary" style="background:#3b82f6; margin-bottom:0;" onclick="saveGithubConfig()">üíæ Guardar API</button>
            </div>

            <!-- SEGURIDAD (Nuevo Ubicaci√≥n) -->
            <div class="card" style="border-color: #f59e0b; background:#0f172a;">
                <h3 style="color:#f59e0b; margin-top:0;">üîê Seguridad</h3>
                <button class="btn-outline" style="width:100%; margin:0;" onclick="openPassModal()">CAMBIAR CONTRASE√ëA DE ACCESO</button>
            </div>
        </div>

        <!-- PANEL 2: PREMIOS Y NUMEROS (UNIFICADO) -->
        <div id="panel-2" class="panel">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h1>Premios</h1>
                <button class="btn-success" style="width:auto; padding:5px 15px;" onclick="openPrizeModal()">+</button>
            </div>
            <div id="prizes-list"></div>

            <h2 style="margin-top:30px; border-bottom:1px solid #334155; padding-bottom:5px;">Control de N√∫meros</h2>
            <div class="card">
                <div style="display:flex; align-items:end; gap:10px; margin-bottom:10px;">
                    <div style="flex:1;">
                        <label>Total de N√∫meros</label>
                        <input type="number" id="ticket-total" value="100" style="margin:0;">
                    </div>
                    <button class="btn-primary" style="width:auto; margin:0;" onclick="generateGrid()">GENERAR</button>
                </div>
                
                <div style="display:flex; gap:10px; margin-bottom:10px; justify-content:center; font-size:0.75rem;">
                    <span style="color:var(--free)">üü¢ Libre</span>
                    <span style="color:var(--sold)">üî¥ Vendido</span>
                    <span style="color:var(--reserved)">üü† Reservado</span>
                </div>
                
                <div id="grid-container" class="ticket-grid"></div>
            </div>
        </div>

        <!-- PANEL 3: FOTOS (WEB CONVERTER) -->
        <div id="panel-3" class="panel">
            <h1>FOTOS & <span>HISTORIAL</span></h1>
            
            <div class="card" style="background:#1e1b29; border:1px solid #333;">
                <p style="font-size:0.85rem; color:#aaa; margin-bottom:15px;">Sube fotos y mant√©n un registro hist√≥rico recuperable.</p>
                <div class="upload-zone" onclick="document.getElementById('imgInput').click()">
                    <span style="font-size:1.2rem;">üì∏</span> SUBIR NUEVA FOTO
                </div>
                <input type="file" id="imgInput" accept="image/*" style="display:none" onchange="uploadImage(this)">
                <div id="upload-status" style="margin-top:10px; color:var(--accent); text-align:center; font-size:0.8rem;"></div>
            </div>

            <div class="history-header">
                <h3 style="margin:0; display:flex; align-items:center; gap:5px;">üìÇ HISTORIAL COMPLETO</h3>
                <button class="btn-outline" style="width:auto; padding:4px 10px; font-size:0.7rem;" onclick="clearHistory()">Limpiar Todo</button>
            </div>
            <p style="font-size:0.7rem; color:#666; margin-bottom:15px;">Toca la foto para verla. Usa la "X" para borrar del historial Y de GitHub.</p>
            
            <div id="history-list"></div>
        </div>
    </main>

    <!-- FAB -->
    <div class="fab-container">
        <button class="fab-btn" onclick="saveToDraft(true)"><span class="fab-icon">üíæ</span>Guardar</button>
        <button class="fab-btn" style="color:#60a5fa;" onclick="publishSite()"><span class="fab-icon">üöÄ</span>Publicar</button>
        <button class="fab-btn" onclick="exportBackup()"><span class="fab-icon">üì•</span>Backup</button>
        <button class="fab-btn" onclick="document.getElementById('importFile').click()"><span class="fab-icon">üì§</span>Restaurar</button>
    </div>
    <input type="file" id="importFile" style="display:none" onchange="importData(this)">

    <!-- MODAL PREMIO -->
    <div id="prize-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 style="color:white;">Editar Premio</h3>
            <input type="hidden" id="pz-id">
            <label>N¬∫ Puesto</label>
            <input type="number" id="pz-rank" placeholder="Ej: 1">
            
            <label>Descripci√≥n</label>
            <input type="text" id="pz-title" placeholder="Ej: Play Station 5">
            <label>Imagen (URL)</label>
            <div style="display:flex; gap:5px;">
                <input type="text" id="pz-img" placeholder="https://..." style="margin:0;">
                <button class="btn-outline" style="width:auto; margin:0;" onclick="pasteImage()">üìã</button>
            </div>
            <div style="margin-top:20px; display:flex; gap:10px;">
                <button class="btn-success" onclick="savePrize()">GUARDAR</button>
                <button class="btn-outline" style="border-color:var(--danger); color:var(--danger);" onclick="deletePrize()">ELIMINAR</button>
            </div>
            <button class="btn-outline" style="margin-top:10px;" onclick="document.getElementById('prize-modal').classList.remove('open')">CANCELAR</button>
        </div>
    </div>

    <!-- MODAL PASSWORD -->
    <div id="pass-modal" class="modal-overlay">
        <div class="modal-content" style="max-width:300px;">
            <h3 style="color:white;">Cambiar Contrase√±a</h3>
            <label>Nueva Contrase√±a</label>
            <input type="password" id="new-pass" placeholder="****" inputmode="numeric" style="text-align:center; letter-spacing:5px;">
            <button class="btn-primary" onclick="saveNewPass()">GUARDAR</button>
            <button class="btn-outline" onclick="document.getElementById('pass-modal').classList.remove('open')">CANCELAR</button>
        </div>
    </div>

    <!-- MASTER TEMPLATE (LA WEB PUBLICA) -->
    <textarea id="master-template" style="display:none;">
<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>${db.config.title}</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">
<style>
    body { background-color: #0f172a; color: #f8fafc; font-family: 'Montserrat', sans-serif; }
    .gold-text { color: #fbbf24; text-shadow: 0 0 15px rgba(251, 191, 36, 0.5); }
    .ticket-cell { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; font-weight: bold; border-radius: 4px; font-size: 0.75rem; transition: transform 0.1s; border: 1px solid rgba(255,255,255,0.1); }
    .ticket-cell:active { transform: scale(0.95); }
    .free { background: rgba(16, 185, 129, 0.1); border-color: #10b981; color: #10b981; cursor: pointer; }
    .sold { background: rgba(239, 68, 68, 0.2); border-color: #ef4444; color: #ef4444; text-decoration: line-through; opacity: 0.5; pointer-events: none; }
    .reserved { background: rgba(245, 158, 11, 0.2); border-color: #f59e0b; color: #f59e0b; opacity: 0.8; pointer-events: none; }
    .selected { background: #3b82f6 !important; border-color: #60a5fa !important; color: white !important; box-shadow: 0 0 15px rgba(59, 130, 246, 0.5); transform: scale(1.05); }

    .modal-buy { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:50; display:none; align-items:center; justify-content:center; padding:20px; }
    
    /* Lightbox para ver fotos */
    .lightbox { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:100; display:none; align-items:center; justify-content:center; p-4; }
    .lightbox img { max-width:95%; max-height:90vh; border-radius:10px; box-shadow: 0 0 30px rgba(0,0,0,0.8); }

    /* Bottom Cart Bar */
    .cart-bar { position: fixed; bottom: 0; left: 0; width: 100%; background: #020617; border-top: 1px solid #334155; padding: 15px; display: none; align-items: center; justify-content: space-between; z-index: 40; box-shadow: 0 -5px 20px rgba(0,0,0,0.5); }
    .cart-bar.visible { display: flex; animation: slideUp 0.3s ease; }
    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
</style>
</head>
<body class="pb-20"> <!-- Padding reducido -->
    
    <!-- HERO COMPACTO -->
    <div class="relative w-full h-40 sm:h-56 overflow-hidden shadow-2xl">
        <div class="absolute inset-0 z-0 bg-slate-900">
             <img src="${db.config.banner}" class="w-full h-full object-cover">
             <div class="absolute inset-0 bg-gradient-to-t from-[#0f172a] via-[#0f172a]/80 to-transparent"></div>
        </div>
        <div class="relative z-10 w-full h-full flex flex-col items-center justify-center text-center px-4">
            <div class="mb-0 w-full flex justify-center">
                DB_TITLE_OR_LOGO_PLACEHOLDER
            </div>
        </div>
    </div>

    <!-- PREMIOS -->
    <div class="max-w-4xl mx-auto px-4 mt-2">
        <div class="text-center mb-4">
            <h2 class="text-xl font-black text-white italic uppercase tracking-wider inline-block border-b-2 border-yellow-500 pb-1">
                ¬°MIR√Å LO QUE POD√âS GANAR! üéâ
            </h2>
        </div>
        <div class="grid grid-cols-2 gap-3 sm:gap-4">
            DB_PRIZES_PLACEHOLDER
        </div>
    </div>

    <!-- NUMEROS -->
    <div class="max-w-3xl mx-auto px-2 mt-4">
        <div class="bg-slate-800/50 backdrop-blur-sm p-4 rounded-2xl border border-slate-700/50 shadow-lg">
            
            <!-- HEADER DE NUMEROS CON PRECIO VISIBLE -->
            <div class="flex justify-between items-end mb-6 px-2 border-b border-gray-600/50 pb-4">
                <div>
                    <h2 class="text-xl font-black text-white uppercase leading-none">Elige tus</h2>
                    <h2 class="text-xl font-black text-yellow-500 uppercase leading-none">N√∫meros</h2>
                </div>
                <div class="flex flex-col items-end">
                    <span class="text-xs text-gray-400 uppercase font-bold">Valor</span>
                    <span class="text-4xl font-black text-green-400 drop-shadow-lg" style="text-shadow: 0 0 10px rgba(74, 222, 128, 0.3);">$${db.config.price}</span>
                </div>
            </div>

            <div class="grid grid-cols-10 gap-1 sm:gap-2">
                DB_GRID_PLACEHOLDER
            </div>
            
            <div class="flex justify-center gap-4 text-[10px] mt-4 font-bold uppercase text-gray-400">
                <span class="flex items-center gap-1"><div class="w-2 h-2 rounded-full bg-emerald-500"></div> Libre</span>
                <span class="flex items-center gap-1"><div class="w-2 h-2 rounded-full bg-red-500"></div> Vendido</span>
                <span class="flex items-center gap-1"><div class="w-2 h-2 rounded-full bg-blue-500"></div> Tu selecci√≥n</span>
            </div>
        </div>
    </div>

    <!-- INFO PAGO COMPACTA CON TELEFONO -->
    <div class="max-w-md mx-auto px-4 mt-4 text-center pb-0">
        <div class="bg-indigo-900/30 border border-indigo-500/20 p-4 rounded-xl">
            <p class="text-indigo-300 text-[10px] uppercase font-bold mb-1">ALIAS / CBU</p>
            <p class="text-lg font-mono text-white select-all bg-black/20 py-2 rounded mb-2">${db.config.cbu}</p>
            
            <div class="flex flex-col items-center gap-2 mt-4">
                <button id="btnSendVoucher" class="bg-green-600 text-white text-xs font-bold px-6 py-3 rounded-full shadow hover:bg-green-500 transition w-full max-w-[250px] uppercase tracking-wide">
                    üì§ Enviar comprobante
                </button>
            </div>
        </div>
    </div>

    <footer class="text-center py-4 text-xs text-gray-500 font-bold tracking-widest mt-2 mb-16">
        ${db.config.footerMsg}
    </footer>

    <!-- CART BAR (Fixed Bottom) -->
    <div id="cartBar" class="cart-bar">
        <div class="flex flex-col">
            <span class="text-gray-400 text-xs uppercase font-bold">Total a pagar</span>
            <span id="cartTotal" class="text-white text-xl font-black font-mono">$0</span>
        </div>
        <button onclick="openFinalModal()" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-6 rounded-lg uppercase shadow-lg shadow-blue-500/30 transition">
            COMPRAR <span id="cartCount" class="bg-white text-blue-600 px-2 py-0.5 rounded-full text-xs ml-1">0</span>
        </button>
    </div>

    <!-- MODAL FINAL -->
    <div id="buyModal" class="modal-buy" onclick="if(event.target === this) this.style.display='none'">
        <div class="bg-slate-900 p-6 rounded-2xl max-w-xs w-full border border-blue-500 text-center relative shadow-2xl overflow-hidden">
            <!-- Glow background effect -->
            <div class="absolute top-0 left-1/2 -translate-x-1/2 w-32 h-32 bg-blue-500/20 blur-3xl rounded-full pointer-events-none"></div>
            
            <button onclick="document.getElementById('buyModal').style.display='none'" class="absolute top-2 right-4 text-2xl text-gray-500 hover:text-white z-10">&times;</button>
            
            <div class="text-6xl mb-4 relative z-10 animate-pulse">üéüÔ∏è‚ú®</div>
            
            <h3 class="text-lg font-bold text-gray-300 mb-1 uppercase">N√∫meros seleccionados</h3>
            <div id="modalNumsList" class="text-white font-black text-xl mb-4 break-words"></div>
            
            <div class="bg-black/30 p-3 rounded-lg border border-white/10 mb-6">
                <p class="text-gray-400 text-xs uppercase mb-1">Total a pagar</p>
                <p id="modalPrice" class="text-4xl font-black text-green-400 font-mono tracking-tight"></p>
            </div>
            
            <button id="btnWa" class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-3.5 rounded-xl shadow-lg transition uppercase text-sm tracking-wide flex items-center justify-center gap-2">
                <span>üí¨</span> PEDIR POR WHATSAPP
            </button>
        </div>
    </div>

    <!-- LIGHTBOX FOTOS -->
    <div id="imgLightbox" class="lightbox" onclick="this.style.display='none'">
        <img id="imgFull" src="" alt="Premio Full">
    </div>

    <script>
        // LOGICA DE CARRITO Y SELECCION
        const ticketPrice = ${db.config.price};
        
        // Whatsapp Link Logic (AUTO +549)
        const waClean = "${db.config.whatsapp}".replace(/[^0-9]/g, '');
        const waFinal = '549' + waClean; 

        // Boton Enviar Comprobante (Con Mensaje)
        document.getElementById('btnSendVoucher').onclick = function() {
             const msgVoucher = encodeURIComponent("Hola! Aqu√≠ env√≠o el comprobante de pago.");
             window.open("https://wa.me/" + waFinal + "?text=" + msgVoucher, '_blank');
        };

        let selectedNumbers = new Set();

        function toggleTicket(num, element) {
            // Si esta vendido o reservado, no hacer nada
            if(element.classList.contains('sold') || element.classList.contains('reserved')) return;

            if(selectedNumbers.has(num)) {
                selectedNumbers.delete(num);
                element.classList.remove('selected');
            } else {
                selectedNumbers.add(num);
                element.classList.add('selected');
            }
            updateCart();
        }

        function updateCart() {
            const count = selectedNumbers.size;
            const bar = document.getElementById('cartBar');
            
            if(count > 0) {
                bar.classList.add('visible');
                document.getElementById('cartCount').innerText = count;
                document.getElementById('cartTotal').innerText = '$' + (count * ticketPrice).toLocaleString();
            } else {
                bar.classList.remove('visible');
            }
        }

        function openFinalModal() {
            const nums = Array.from(selectedNumbers).sort((a,b) => parseInt(a)-parseInt(b));
            const total = nums.length * ticketPrice;
            
            document.getElementById('modalNumsList').innerText = nums.join(', ');
            document.getElementById('modalPrice').innerText = '$' + total.toLocaleString();
            
            // Link de WhatsApp CON TOTAL
            const msg = encodeURIComponent(`Hola! Quiero reservar los n√∫meros: ${nums.join(', ')}. Total a pagar: $${total}`);
            const link = "https://wa.me/" + waFinal + "?text=" + msg;
            
            document.getElementById('btnWa').onclick = function() { window.open(link, '_blank'); };
            document.getElementById('buyModal').style.display = 'flex';
        }
        
        function viewImg(url) {
            document.getElementById('imgFull').src = url;
            document.getElementById('imgLightbox').style.display = 'flex';
        }
    </script>
</body>
</html>
    </textarea>

    <script>
        const defaultDB = {
            config: { title: "SALE O SALE", logo: "", logoScale: "50", date: "Sortea Pronto", price: "1000", cbu: "alias.ejemplo", whatsapp: "", footerMsg: "¬°Gracias por participar!", banner: "https://via.placeholder.com/800x400/1e293b/ffffff?text=BANNER" },
            prizes: [],
            tickets: { total: 100, status: {} }, 
            images: []
        };
        
        let db = JSON.parse(JSON.stringify(defaultDB));

        // --- AUTH & INIT ---
        function checkLogin() {
            if(document.getElementById('login-pass').value === (localStorage.getItem('rifa_pass') || '1234')) {
                document.getElementById('login-screen').style.display = 'none';
                checkForDraft(); 
                loadGithubConfig();
            } else alert('Contrase√±a incorrecta');
        }

        // --- PASSWORD CHANGE ---
        function openPassModal() { document.getElementById('pass-modal').classList.add('open'); }
        function saveNewPass() {
            const p = document.getElementById('new-pass').value;
            if(p.length < 4) return alert("M√≠nimo 4 caracteres");
            localStorage.setItem('rifa_pass', p);
            alert("Contrase√±a actualizada");
            document.getElementById('pass-modal').classList.remove('open');
        }

        // --- RESTORE DRAFT CHECK ---
        function checkForDraft() {
            const d = localStorage.getItem('rifa_draft');
            if(d) {
                document.getElementById('restore-notice').style.display = 'block';
                refreshUI(); 
            } else {
                refreshUI();
            }
        }

        // --- CORE UI ---
        function switchPanel(idx) {
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            document.getElementById('panel-'+idx).classList.add('active');
            document.querySelectorAll('.nav-pill').forEach((n,i) => i===idx ? n.classList.add('active') : n.classList.remove('active'));
        }

        function updateScaleVal(val) {
            document.getElementById('logo-scale-val').innerText = val;
        }

        function refreshUI() {
            // Stats
            let s=0, r=0, f=0;
            const total = parseInt(db.tickets.total) || 100;
            for(let i=0; i<total; i++) {
                const st = db.tickets.status[i];
                if(st === 'sold') s++; else if(st === 'reserved') r++; else f++;
            }
            document.getElementById('stat-sold').innerText = s;
            document.getElementById('stat-reserved').innerText = r;
            document.getElementById('stat-free').innerText = f;
            document.getElementById('stat-money').innerText = '$' + (s * (parseInt(db.config.price)||0)).toLocaleString();

            // Config Form
            document.getElementById('cfg-title').value = db.config.title;
            document.getElementById('cfg-logo').value = db.config.logo || '';
            document.getElementById('cfg-logo-scale').value = db.config.logoScale || 50;
            updateScaleVal(db.config.logoScale || 50);
            
            document.getElementById('cfg-date').value = db.config.date;
            document.getElementById('cfg-price').value = db.config.price;
            document.getElementById('cfg-cbu').value = db.config.cbu;
            document.getElementById('cfg-whatsapp').value = db.config.whatsapp;
            document.getElementById('cfg-footer-msg').value = db.config.footerMsg || '';
            document.getElementById('cfg-banner').value = db.config.banner;

            // Grids & Lists
            renderPrizes();
            document.getElementById('ticket-total').value = db.tickets.total;
            renderGrid();
            renderHistory();
        }

        function saveToDraft(notify=true) {
            db.config.title = document.getElementById('cfg-title').value;
            db.config.logo = document.getElementById('cfg-logo').value;
            db.config.logoScale = document.getElementById('cfg-logo-scale').value;
            db.config.date = document.getElementById('cfg-date').value;
            db.config.price = document.getElementById('cfg-price').value;
            db.config.cbu = document.getElementById('cfg-cbu').value;
            db.config.whatsapp = document.getElementById('cfg-whatsapp').value;
            db.config.footerMsg = document.getElementById('cfg-footer-msg').value;
            db.config.banner = document.getElementById('cfg-banner').value;
            
            localStorage.setItem('rifa_draft', JSON.stringify(db));
            document.getElementById('restore-notice').style.display = 'none'; 
            if(notify) showToast("Guardado localmente");
        }

        function loadDraft() {
            const d = localStorage.getItem('rifa_draft');
            if(d) {
                db = JSON.parse(d);
                document.getElementById('restore-notice').style.display = 'none'; 
                refreshUI();
                showToast("Datos restaurados");
            }
        }

        function resetDefault() {
            if(confirm("¬øBorrar todo y empezar de cero?")) {
                db = JSON.parse(JSON.stringify(defaultDB));
                refreshUI();
                document.getElementById('restore-notice').style.display = 'none'; 
            }
        }

        function showToast(msg) { const t = document.getElementById('toast'); t.innerText = msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2000); }

        // --- PREMIOS ---
        function renderPrizes() {
            const list = document.getElementById('prizes-list');
            list.innerHTML = db.prizes.map((p,i) => `
                <div class="prize-item" onclick="openPrizeModal(${i})">
                    <img src="${p.img||''}" class="prize-img-sm" onerror="this.style.backgroundColor='#333'">
                    <div style="flex:1;">
                        <div style="color:var(--accent); font-weight:bold; font-size:0.8rem;">Puesto: ${p.rank}</div>
                        <div style="font-weight:bold; color:white;">${p.title}</div>
                    </div>
                    <span>‚úèÔ∏è</span>
                </div>
            `).join('');
        }

        function openPrizeModal(idx=null) {
            if(idx!==null) {
                const p = db.prizes[idx];
                document.getElementById('pz-id').value = idx;
                document.getElementById('pz-rank').value = p.rank;
                document.getElementById('pz-title').value = p.title;
                document.getElementById('pz-img').value = p.img;
            } else {
                document.getElementById('pz-id').value = "";
                ['pz-rank','pz-title','pz-img'].forEach(id=>document.getElementById(id).value="");
            }
            document.getElementById('prize-modal').classList.add('open');
        }

        function savePrize() {
            const id = document.getElementById('pz-id').value;
            const obj = { 
                rank: document.getElementById('pz-rank').value,
                title: document.getElementById('pz-title').value,
                img: document.getElementById('pz-img').value
            };
            if(id!=="") db.prizes[id] = obj;
            else db.prizes.push(obj);
            
            document.getElementById('prize-modal').classList.remove('open');
            saveToDraft(false); refreshUI();
        }
        
        function deletePrize() {
            const id = document.getElementById('pz-id').value;
            if(id!=="") { db.prizes.splice(id,1); document.getElementById('prize-modal').classList.remove('open'); saveToDraft(false); refreshUI(); }
        }

        // --- NUMEROS (GRID) ---
        function generateGrid() {
            const newTotal = parseInt(document.getElementById('ticket-total').value);
            if(confirm(`¬øCambiar grilla a ${newTotal} n√∫meros? (No borra estados si el n√∫mero existe)`)) {
                db.tickets.total = newTotal;
                saveToDraft(false); refreshUI();
            }
        }

        function renderGrid() {
            const container = document.getElementById('grid-container');
            let html = '';
            for(let i=0; i<db.tickets.total; i++) {
                const st = db.tickets.status[i] || 'free'; 
                // START AT 01 LOGIC
                const displayNum = i + 1;
                const pad = displayNum < 10 ? '0' + displayNum : displayNum;
                html += `<div class="ticket-cell ${st}" onclick="cycleTicket(${i})">${pad}</div>`;
            }
            container.innerHTML = html;
        }

        function cycleTicket(idx) {
            const states = ['free', 'reserved', 'sold'];
            const current = db.tickets.status[idx] || 'free';
            let next = states[(states.indexOf(current) + 1) % 3];
            
            if(next === 'free') delete db.tickets.status[idx];
            else db.tickets.status[idx] = next;
            
            saveToDraft(false); refreshUI();
        }

        // --- GITHUB & DEPLOY ---
        function loadGithubConfig() {
            const c = JSON.parse(localStorage.getItem('rifa_github')||'{}');
            document.getElementById('gh-user').value = c.user||'';
            document.getElementById('gh-repo').value = c.repo||'';
            document.getElementById('gh-token').value = c.token||'';
        }
        function saveGithubConfig() {
            localStorage.setItem('rifa_github', JSON.stringify({
                user: document.getElementById('gh-user').value,
                repo: document.getElementById('gh-repo').value,
                token: document.getElementById('gh-token').value
            }));
            showToast("API Guardada");
        }

        async function uploadImage(input) {
            if(!input.files[0]) return;
            const file = input.files[0];
            const reader = new FileReader();
            document.getElementById('upload-status').innerText = "Procesando...";
            
            reader.onload = async function(e) {
                const img = new Image(); img.src = e.target.result;
                img.onload = async function() {
                    const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
                    const scale = 800 / Math.max(img.width, img.height);
                    canvas.width = img.width * scale; canvas.height = img.height * scale;
                    ctx.drawImage(img,0,0,canvas.width,canvas.height);
                    
                    const base64 = canvas.toDataURL('image/webp', 0.8).split(',')[1];
                    const gh = JSON.parse(localStorage.getItem('rifa_github')||'{}');
                    if(!gh.token) { alert("Configura GitHub primero"); return; }
                    
                    const filename = `img_${Date.now()}.webp`;
                    const url = `https://api.github.com/repos/${gh.user}/${gh.repo}/contents/uploads/${filename}`;
                    
                    document.getElementById('upload-status').innerText = "Subiendo a GitHub...";
                    
                    try {
                        const req = await fetch(url, {
                            method: 'PUT',
                            headers: { Authorization: `token ${gh.token}`, 'Content-Type': 'application/json' },
                            body: JSON.stringify({ message: "Upload", content: base64 })
                        });
                        const res = await req.json();
                        if(req.ok) {
                            // Guardamos OBJETO con metadatos para poder borrarlo luego
                            db.images.unshift({
                                url: res.content.download_url,
                                path: res.content.path,
                                sha: res.content.sha,
                                date: new Date().toLocaleString()
                            });
                            saveToDraft(false); renderHistory();
                            document.getElementById('upload-status').innerText = "‚úÖ Subida OK.";
                        } else alert("Error GitHub: " + res.message);
                    } catch(err) { alert("Error red"); }
                }
            };
            reader.readAsDataURL(file);
        }

        function renderHistory() {
            document.getElementById('history-list').innerHTML = (db.images||[]).map((imgObj, idx) => {
                // Compatibilidad con versiones viejas (si solo guardabamos string)
                const url = typeof imgObj === 'string' ? imgObj : imgObj.url;
                const date = typeof imgObj === 'string' ? '---' : (imgObj.date || '---');
                
                return `
                <div class="history-card">
                    <img src="${url}" class="history-thumb" onclick="window.open('${url}','_blank')">
                    <div class="history-info">
                        <span class="history-url">${url}</span>
                        <span class="history-date">${date}</span>
                    </div>
                    <div class="history-actions">
                        <button class="btn-icon-sm" onclick="navigator.clipboard.writeText('${url}'); showToast('Copiado')">üìã</button>
                        <button class="btn-icon-sm btn-delete-sm" onclick="deleteImage(${idx})">‚úñ</button>
                    </div>
                </div>
            `}).join('');
        }

        async function deleteImage(index) {
            const imgData = db.images[index];
            const isObj = typeof imgData === 'object';
            const url = isObj ? imgData.url : imgData;
            
            if(!confirm("¬øBorrar esta imagen? Se eliminar√° de la lista y de GitHub.")) return;

            // Intentar borrar de GitHub
            const gh = JSON.parse(localStorage.getItem('rifa_github')||'{}');
            if(gh.token && isObj && imgData.path) {
                // Tenemos path, intentamos obtener SHA fresco
                try {
                    showToast("Borrando de GitHub...");
                    const getUrl = `https://api.github.com/repos/${gh.user}/${gh.repo}/contents/${imgData.path}`;
                    const getReq = await fetch(getUrl, { headers: { Authorization: `token ${gh.token}`}});
                    
                    if(getReq.ok) {
                        const fileData = await getReq.json();
                        const sha = fileData.sha;
                        
                        // Delete call
                        await fetch(getUrl, {
                            method: 'DELETE',
                            headers: { Authorization: `token ${gh.token}`, 'Content-Type': 'application/json' },
                            body: JSON.stringify({ message: "Delete image via Editor", sha: sha })
                        });
                    }
                } catch(e) { console.log("Error deleting remote", e); }
            }

            // Borrar local
            db.images.splice(index, 1);
            saveToDraft(false);
            renderHistory();
            showToast("Imagen eliminada");
        }
        
        function clearHistory() {
            if(confirm("¬øLimpiar todo el historial local? (No borra de GitHub)")) {
                db.images = [];
                saveToDraft(false);
                renderHistory();
            }
        }

        function pasteImage() { navigator.clipboard.readText().then(t => document.getElementById('pz-img').value = t); }

        function exportBackup() {
            const blob = new Blob([JSON.stringify(db)], {type:'application/json'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download='rifa-backup.json'; a.click();
        }
        function importData(input) {
            const r = new FileReader(); r.onload=e=>{ db=JSON.parse(e.target.result); saveToDraft(false); refreshUI(); };
            r.readAsText(input.files[0]);
        }

        // --- PUBLICAR / PREVIEW / DOWNLOAD ---
        function getHtml() {
            let tpl = document.getElementById('master-template').value;
            
            // Build Prizes HTML
            let prizesHtml = db.prizes.map(p => {
                let rankText = p.rank;
                if(p.rank === '1' || p.rank === 1) rankText = '1¬∞ PREMIO';
                else if(p.rank === '2' || p.rank === 2) rankText = '2¬∞ PREMIO';
                else if(p.rank === '3' || p.rank === 3) rankText = '3¬∞ PREMIO';
                else if(!isNaN(p.rank) && p.rank) rankText = `${p.rank}¬∞ PREMIO`;

                return `
                <div class="relative bg-slate-900 border border-yellow-500/30 rounded-lg overflow-hidden group">
                    <div class="absolute top-0 w-full bg-yellow-500 text-black font-bold text-[0.6rem] uppercase py-1 text-center shadow-md z-10 truncate px-2">
                        ${rankText}
                    </div>
                    <div class="h-32 bg-black mt-5 cursor-zoom-in relative" onclick="viewImg('${p.img}')">
                        <img src="${p.img}" class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition">
                        <div class="absolute bottom-1 right-1 bg-black/60 text-white text-[10px] px-2 py-0.5 rounded-full backdrop-blur-sm flex items-center gap-1">
                            üîç Ver foto
                        </div>
                    </div>
                    <div class="p-2 text-center bg-slate-900">
                        <h3 class="text-white font-bold text-xs uppercase leading-tight truncate">${p.title}</h3>
                    </div>
                </div>
            `}).join('');
            
            // Build Grid HTML
            let gridHtml = '';
            for(let i=0; i<db.tickets.total; i++) {
                const st = db.tickets.status[i] || 'free';
                const displayNum = i + 1;
                const pad = displayNum < 10 ? '0' + displayNum : displayNum;
                
                const action = st === 'free' ? `onclick="toggleTicket('${pad}', this)"` : '';
                gridHtml += `<div class="ticket-cell ${st}" ${action}>${pad}</div>`;
            }

            // LOGICA LOGO VS TITULO + ESCALADO
            let titleOrLogoHtml = '';
            if(db.config.logo && db.config.logo.length > 5) {
                const scale = db.config.logoScale || 50;
                titleOrLogoHtml = `<img src="${db.config.logo}" style="width: ${scale}%; max-width: 500px; height: auto;" class="object-contain drop-shadow-xl animate-fade-in">`;
            } else {
                titleOrLogoHtml = `
                    <h1 class="text-4xl sm:text-5xl font-black uppercase tracking-tighter text-white mb-2 drop-shadow-[0_2px_4px_rgba(0,0,0,0.8)] leading-none">
                        ${db.config.title}
                    </h1>`;
            }
            
            // Whatsapp Link Logic (AUTO +549)
            const waClean = db.config.whatsapp.replace(/[^0-9]/g, '');
            const waFinal = '549' + waClean; 

            // Replace
            tpl = tpl.replace('DB_TITLE_OR_LOGO_PLACEHOLDER', titleOrLogoHtml)
                     .replace('${db.config.title}', db.config.title) 
                     .replace('${db.config.title}', db.config.title) 
                     .replace('${db.config.date}', db.config.date) 
                     .replace('${db.config.banner}', db.config.banner)
                     .replace('${db.config.price}', db.config.price)
                     .replace('${db.config.price}', db.config.price) 
                     .replace('${db.config.price}', db.config.price) 
                     .replace('${db.config.price}', db.config.price) 
                     .replace('${db.config.cbu}', db.config.cbu)
                     .replace('${db.config.footerMsg}', db.config.footerMsg || '')
                     .replace('"${db.config.whatsapp}"', `"${waClean}"`) 
                     .replace('DB_PRIZES_PLACEHOLDER', prizesHtml)
                     .replace('DB_GRID_PLACEHOLDER', gridHtml);
            
            return tpl;
        }

        function openPreview() {
            saveToDraft(false);
            const w = window.open();
            w.document.write(getHtml());
            w.document.close();
        }

        function downloadIndex() {
            const htmlContent = getHtml();
            const blob = new Blob([htmlContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'index.html';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast("Descargando index.html...");
        }

        async function publishSite() {
            if(!confirm("¬øPublicar cambios en la web?")) return;
            saveToDraft(false);
            const gh = JSON.parse(localStorage.getItem('rifa_github')||'{}');
            if(!gh.token) return alert("Falta API Github");

            const content = btoa(unescape(encodeURIComponent(getHtml())));
            showToast("Subiendo index.html...");
            
            try {
                // Get SHA first
                const url = `https://api.github.com/repos/${gh.user}/${gh.repo}/contents/index.html`;
                const getReq = await fetch(url, { headers: { Authorization: `token ${gh.token}`}});
                const getData = getReq.ok ? await getReq.json() : {};
                
                const putReq = await fetch(url, {
                    method: 'PUT',
                    headers: { Authorization: `token ${gh.token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: "Deploy Sorteo",
                        content: content,
                        sha: getData.sha
                    })
                });
                
                if(putReq.ok) alert("‚úÖ SITIO PUBLICADO EXITOSAMENTE");
                else alert("Error al publicar");
            } catch(e) { alert("Error: " + e.message); }
        }
    </script>
</body>
</html>